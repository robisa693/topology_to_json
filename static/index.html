<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Topology Builder</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<!-- <link rel="icon" href="/static/favicon.ico"> -->
<link rel="icon" type="image/svg+xml" href="/static/favicon.svg">

<style>
/*─────────────────────────────────────────────────────────────────────────────
  RESET & TOKENS
─────────────────────────────────────────────────────────────────────────────*/
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --c-bg:      #0d0d0d;
  --c-panel:   #131313;
  --c-card:    #191919;
  --c-input:   #1e1e1e;
  --c-border:  rgba(255,255,255,.07);
  --c-border2: rgba(255,255,255,.13);
  --c-text:    #dedede;
  --c-dim:     #585858;
  --c-faint:   #2e2e2e;
  --font:      'IBM Plex Mono', monospace;
}
html, body { height: 100%; overflow: hidden; background: var(--c-bg); color: var(--c-text); font-family: var(--font); }
button { font-family: var(--font); cursor: pointer; }
input, select { font-family: var(--font); }
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #282828; border-radius: 2px; }

/*─────────────────────────────────────────────────────────────────────────────
  APP SHELL
─────────────────────────────────────────────────────────────────────────────*/
#app { display: flex; height: 100vh; overflow: hidden; }

/*─────────────────────────────────────────────────────────────────────────────
  LEFT PALETTE
─────────────────────────────────────────────────────────────────────────────*/
#palette {
  width: 172px; flex-shrink: 0;
  background: var(--c-panel);
  border-right: 1px solid var(--c-border);
  display: flex; flex-direction: column;
}
#pal-logo { padding: 12px 12px 10px; border-bottom: 1px solid var(--c-border); }
#logo-icon { margin-bottom: 8px; }
#logo-icon img { display: block; }
#pal-logo .name {
  font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 12px; letter-spacing: .06em;
  background: linear-gradient(135deg,#d8d8d8,#888888);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
#pal-logo .sub { font-size: 8px; color: var(--c-faint); letter-spacing: .22em; margin-top: 2px; }
#pal-nodes { flex: 1; overflow-y: auto; padding: 10px 8px; }
#pal-nodes .section-label { font-size: 8px; color: var(--c-faint); letter-spacing: .15em; display: block; margin-bottom: 8px; }
.pal-btn {
  display: flex; align-items: center; gap: 8px; width: 100%; padding: 7px 10px; margin-bottom: 4px;
  border-radius: 6px; border: 1px solid; background: none; font-size: 10px; font-weight: 500;
  text-align: left; transition: filter .15s, transform .12s;
}
.pal-btn:hover { filter: brightness(1.4); transform: translateX(2px); }
.pal-btn .pi { font-size: 14px; }
#pal-footer { padding: 10px 8px; border-top: 1px solid var(--c-border); }
#btn-settings {
  width: 100%; padding: 8px 10px; border-radius: 6px;
  border: 1px solid var(--c-border); background: rgba(255,255,255,.02);
  color: var(--c-dim); font-size: 9px; letter-spacing: .1em; transition: all .2s;
}
#btn-settings:hover { color: var(--c-text); border-color: var(--c-border2); }
#pal-stats { margin-top: 8px; font-size: 9px; color: var(--c-faint); line-height: 2.2; }
#pal-stats em { color: #a0a0a0; font-style: normal; }

/*─────────────────────────────────────────────────────────────────────────────
  CANVAS
─────────────────────────────────────────────────────────────────────────────*/
#canvas {
  flex: 1; position: relative; overflow: hidden; min-width: 0;
  cursor: grab;
  background-color: #0f0f0f;
  background-image:
    linear-gradient(rgba(255,255,255,.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,.04) 1px, transparent 1px),
    linear-gradient(rgba(255,255,255,.015) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,.015) 1px, transparent 1px);
  background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;
}
#world { position: absolute; transform-origin: 0 0; will-change: transform; }
#esvg  {
  position: absolute; left: 0; top: 0; width: 12000px; height: 8000px;
  overflow: visible; pointer-events: none; z-index: 2;
}

/* Nodes */
.node {
  position: absolute; border-radius: 10px; border: 1px solid;
  background: var(--c-card); user-select: none;
  overflow: visible; transition: box-shadow .15s, border-color .15s, opacity .15s;
}
.node-head {
  height: 44px; display: flex; align-items: center; gap: 8px; padding: 0 10px;
  border-radius: 9px 9px 0 0; border-bottom: 1px solid rgba(255,255,255,.04);
}
.node-icon  { font-size: 15px; flex-shrink: 0; }
.node-title { flex: 1; overflow: hidden; }
.node-name  { font-size: 11px; font-weight: 600; color: var(--c-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.node-type  { font-size: 8px; opacity: .5; letter-spacing: .1em; text-transform: uppercase; }
.node-props { padding: 2px 10px 8px; }
.prow { display: flex; gap: 6px; align-items: center; min-height: 24px; border-bottom: 1px solid rgba(255,255,255,.025); }
.prow:last-child { border-bottom: none; }
.pk   { font-size: 9px; color: var(--c-faint); flex-shrink: 0; min-width: 58px; }
.pv   { font-size: 9px; color: var(--c-dim); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
.ptags { display: flex; flex-wrap: wrap; gap: 3px; padding: 4px 0 2px; }
.ptag  { font-size: 8px; padding: 1px 5px; border-radius: 3px; border: 1px solid; }

/* Ports */
.port {
  position: absolute; width: 14px; height: 14px; border-radius: 50%; top: 50%; transform: translateY(-50%);
  border: 2px solid; background: var(--c-card); z-index: 20;
  transition: transform .12s, background .12s;
}
.port-in  { left: -8px;  cursor: crosshair; }
.port-out { right: -8px; cursor: crosshair; }
.port-out:hover { transform: translateY(-50%) scale(1.5); }

/* Edge groups */
.eg { cursor: pointer; }
.eg .edel { opacity: 0; transition: opacity .15s; pointer-events: none; }
.eg:hover .edel { opacity: 1; pointer-events: all; }

/* Canvas overlays */
#c-toolbar {
  position: absolute; top: 14px; right: 14px; display: flex; gap: 8px; z-index: 30;
}
.c-tbtn {
  padding: 6px 14px; border-radius: 6px; border: 1px solid; background: rgba(0,0,0,.4);
  backdrop-filter: blur(4px); font-size: 9px; letter-spacing: .08em; transition: all .15s;
}
#btn-del-node { border-color: rgba(239,68,68,.35); color: #ef4444; display: none; }
#btn-del-node:hover { background: rgba(239,68,68,.12); }
#btn-hide-panel { border-color: var(--c-border); color: var(--c-dim); }
#btn-hide-panel:hover { border-color: var(--c-border2); color: var(--c-text); }

#zoom-ui {
  position: absolute; bottom: 18px; right: 14px; display: flex; flex-direction: column; gap: 4px; z-index: 30;
}
.zbtn {
  width: 30px; height: 30px; border-radius: 5px; border: 1px solid var(--c-border);
  background: rgba(0,0,0,.45); color: var(--c-dim); font-size: 18px;
  display: flex; align-items: center; justify-content: center; transition: all .15s;
}
.zbtn:hover { border-color: var(--c-border2); color: var(--c-text); }
#zoom-pct {
  width: 30px; height: 22px; border-radius: 4px; border: 1px solid var(--c-border);
  background: rgba(0,0,0,.35); color: var(--c-faint); font-size: 8px;
  display: flex; align-items: center; justify-content: center; cursor: pointer; letter-spacing: .03em;
}
#zoom-pct:hover { color: var(--c-dim); }

#conn-hint {
  display: none; position: absolute; top: 14px; left: 50%; transform: translateX(-50%);
  background: rgba(10,14,27,.92); border: 1px solid var(--c-border); border-radius: 6px;
  padding: 6px 18px; font-size: 9px; color: var(--c-dim); letter-spacing: .08em;
  pointer-events: none; white-space: nowrap; z-index: 30; backdrop-filter: blur(4px);
}
#conn-hint strong { color: var(--c-text); }
#conn-hint span   { color: rgba(239,68,68,.6); }

#flash {
  display: none; position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%);
  padding: 8px 22px; border-radius: 8px; font-size: 11px; letter-spacing: .03em;
  pointer-events: none; white-space: nowrap; z-index: 30;
  background: rgba(10,14,27,.95); border: 1px solid;
}

#empty {
  position: absolute; inset: 0; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 14px; pointer-events: none;
}
#empty .et { font-family: 'Orbitron', sans-serif; font-size: 10px; color: #222222; letter-spacing: .3em; }
#empty .ei span { font-size: 22px; margin: 0 7px; }
#empty .eh { font-size: 10px; color: #222222; }
#empty .es { font-size: 9px;  color: #1a1a1a; }

/*─────────────────────────────────────────────────────────────────────────────
  RIGHT PANEL
─────────────────────────────────────────────────────────────────────────────*/
#right {
  width: 298px; flex-shrink: 0; background: var(--c-panel);
  border-left: 1px solid var(--c-border); display: flex; flex-direction: column; overflow: hidden;
}
/* Property editor */
#props {
  flex-shrink: 0; max-height: 56%; overflow-y: auto;
  border-bottom: 1px solid var(--c-border);
}
#props-inner { padding: 14px; }
.props-empty { font-size: 9px; color: var(--c-faint); letter-spacing: .12em; padding: 4px 0; }
.pf-label { font-size: 9px; color: var(--c-dim); display: block; margin-bottom: 3px; letter-spacing: .06em; margin-top: 8px; }
.pf-label:first-child { margin-top: 0; }
.pf-input {
  width: 100%; padding: 5px 8px; background: var(--c-input); border: 1px solid var(--c-border);
  border-radius: 5px; color: var(--c-text); font-size: 11px; outline: none; transition: border-color .15s;
}
.pf-input:focus { border-color: var(--c-border2); }
.pf-input[type=number] { -moz-appearance: textfield; }
.pf-select { appearance: none; cursor: pointer; }
.ms-wrap { display: flex; flex-wrap: wrap; gap: 4px; padding: 3px 0; }
.ms-opt {
  padding: 3px 8px; border-radius: 4px; border: 1px solid; font-size: 9px;
  cursor: pointer; transition: all .1s; user-select: none;
}
/* JSON panel */
#jpanel { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
#jhead {
  flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
  padding: 9px 14px; border-bottom: 1px solid var(--c-border);
}
#jhead span { font-size: 9px; color: var(--c-faint); letter-spacing: .15em; }
#jbtns { display: flex; gap: 5px; }
.jbtn {
  padding: 4px 10px; border-radius: 4px; border: 1px solid; background: rgba(255,255,255,.02);
  font-size: 9px; transition: all .15s;
}
#btn-copy { border-color: var(--c-border); color: var(--c-dim); }
#btn-copy:hover, #btn-copy.ok { border-color: rgba(140,200,140,.4); color: #7cb87c; background: rgba(140,200,140,.07); }
#btn-dl   { border-color: rgba(180,180,180,.3); color: #a0a0a0; background: rgba(180,180,180,.07); }
#btn-dl:hover { background: rgba(180,180,180,.15); }
#jout {
  flex: 1; overflow: auto; padding: 12px 14px; margin: 0;
  font-size: 10px; line-height: 1.9; background: transparent;
}
#jfoot {
  flex-shrink: 0; padding: 6px 14px; border-top: 1px solid rgba(255,255,255,.03);
  display: flex; gap: 14px; font-size: 8px; color: var(--c-faint);
}
#jfoot em { color: #a0a0a0; font-style: normal; }
/* JSON colors */
.jk { color: #a0a0a0; } .js { color: #7cb87c; } .jn { color: #b8895a; }
.jb { color: #8f82c4; } .jnu { color: #505050; } .jp { color: var(--c-faint); }

/*─────────────────────────────────────────────────────────────────────────────
  SETTINGS MODAL
─────────────────────────────────────────────────────────────────────────────*/
#overlay {
  display: none; position: fixed; inset: 0; z-index: 100;
  background: rgba(0,0,0,.8); backdrop-filter: blur(8px);
  align-items: center; justify-content: center;
}
#overlay.open { display: flex; }
#modal {
  background: #111111; border: 1px solid var(--c-border); border-radius: 14px;
  width: min(880px, 96vw); height: 87vh;
  display: flex; flex-direction: column; overflow: hidden;
  box-shadow: 0 30px 90px rgba(0,0,0,.9);
}
#mhead {
  flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
  padding: 16px 20px; border-bottom: 1px solid var(--c-border);
}
#mhead h2 { font-family: 'Orbitron',sans-serif; font-weight: 900; font-size: 13px; letter-spacing: .08em; }
#mhead p  { font-size: 9px; color: var(--c-faint); letter-spacing: .14em; margin-top: 2px; }
#mhead-btns { display: flex; gap: 8px; align-items: center; }
.m-btn { padding: 6px 14px; border-radius: 5px; border: 1px solid; font-size: 10px; transition: all .15s; }
#btn-m-export { border-color: rgba(180,180,180,.35); color: #a0a0a0; background: rgba(180,180,180,.08); }
#btn-m-export:hover { background: rgba(180,180,180,.18); }
#btn-m-import { border-color: var(--c-border); color: var(--c-dim); background: rgba(255,255,255,.02); }
#btn-m-import:hover { border-color: var(--c-border2); color: var(--c-text); }
#btn-m-close  { border-color: var(--c-border); color: var(--c-faint); background: none; font-size: 14px; padding: 4px 10px; }
/* Tabs */
#mtabs { flex-shrink: 0; display: flex; border-bottom: 1px solid var(--c-border); }
.mtab {
  padding: 11px 20px; border: none; border-bottom: 2px solid transparent;
  background: none; font-size: 10px; font-weight: 600; letter-spacing: .1em; color: var(--c-faint);
  transition: all .15s;
}
.mtab.on { color: var(--c-text); border-bottom-color: #a0a0a0; }
#mbody { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
.mpanel { display: none; flex: 1; overflow: hidden; }
.mpanel.on { display: flex; }

/* ── Types tab ── */
#tp { flex-direction: row; }
#tlist {
  width: 234px; flex-shrink: 0; overflow-y: auto;
  border-right: 1px solid var(--c-border); padding: 14px 12px;
  display: flex; flex-direction: column;
}
#tlist label { font-size: 8px; color: var(--c-faint); letter-spacing: .15em; display: block; margin-bottom: 8px; }
#tlist-items { flex: 1; overflow-y: auto; }
.ti {
  display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 7px;
  cursor: pointer; margin-bottom: 3px; border: 1px solid rgba(255,255,255,.04);
  background: rgba(255,255,255,.01); transition: all .12s;
}
.ti.on { background: rgba(255,255,255,.05); }
.ti .tiicon { font-size: 15px; flex-shrink: 0; }
.ti .tiinfo { flex: 1; min-width: 0; }
.ti .tiname { font-size: 10px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ti .timeta { font-size: 8px; color: var(--c-faint); }
.ti .tidel  { color: rgba(239,68,68,.35); font-size: 13px; flex-shrink: 0; padding: 0 2px; }
.ti .tidel:hover { color: #ef4444; }
#tadd { display: flex; gap: 6px; margin-top: 10px; flex-shrink: 0; }
/* Schema editor */
#tschema { flex: 1; overflow-y: auto; padding: 18px 20px; }
#tschema-ph  { display: flex; align-items: center; justify-content: center; height: 100%; font-size: 10px; color: var(--c-faint); }
#tschema-ed  { display: none; }
#tmeta-row   { display: grid; grid-template-columns: 1fr 160px 64px auto; gap: 10px; align-items: end; margin-bottom: 20px; }
#tmeta-color { display: flex; gap: 5px; align-items: center; }
#color-pick  { width: 32px; height: 32px; padding: 2px; background: none; border: 1px solid var(--c-border); border-radius: 4px; cursor: pointer; }
#tprops-hd   { font-size: 9px; color: var(--c-faint); letter-spacing: .1em; margin-bottom: 10px; }
#tprops-list { display: flex; flex-direction: column; gap: 8px; }
.prop-card {
  background: rgba(255,255,255,.02); border: 1px solid var(--c-border); border-radius: 8px; padding: 10px 12px;
}
.prop-row1 { display: grid; grid-template-columns: 110px 1fr 132px 100px auto; gap: 8px; align-items: end; }
.prop-opts { margin-top: 8px; }
.prop-opts label { font-size: 8px; color: var(--c-faint); display: block; margin-bottom: 5px; }
.optags { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 6px; min-height: 24px; }
.otag {
  display: flex; align-items: center; gap: 3px; background: rgba(255,255,255,.04);
  border: 1px solid var(--c-border); border-radius: 4px; padding: 2px 6px; font-size: 9px;
}
.otag .ox { color: rgba(239,68,68,.4); cursor: pointer; font-size: 12px; line-height: 1; }
.otag .ox:hover { color: #ef4444; }
.oadd { display: flex; gap: 5px; }
#btn-add-prop {
  width: 100%; margin-top: 10px; padding: 8px; border: 1px dashed var(--c-border);
  border-radius: 6px; background: none; color: var(--c-faint); font-size: 10px; letter-spacing: .08em;
  transition: all .15s;
}
#btn-add-prop:hover { border-color: var(--c-border2); color: var(--c-dim); }

/* ── Rules tab ── */
#rp { flex-direction: column; padding: 18px 20px; overflow-y: auto; }
#rp > p { font-size: 10px; color: var(--c-dim); line-height: 1.7; margin-bottom: 16px; }
#rtable-wrap { overflow-x: auto; }
#rtable { border-collapse: collapse; }
#rtable .rco { width: 170px; min-width: 170px; text-align: left; padding: 0 14px 10px 0; font-size: 9px; color: var(--c-faint); letter-spacing: .1em; border-bottom: 1px solid var(--c-border); }
#rtable .rch { width: 70px; min-width: 70px; text-align: center; padding: 6px 4px 10px; border-bottom: 1px solid var(--c-border); }
#rtable .rch .rch-i { font-size: 15px; display: block; }
#rtable .rch .rch-l { font-size: 8px; color: var(--c-faint); white-space: nowrap; }
#rtable .rrl { display: flex; align-items: center; gap: 8px; padding: 5px 14px 5px 0; width: 170px; min-width: 170px; border-bottom: 1px solid rgba(255,255,255,.025); }
#rtable .rrl .rrl-i { font-size: 13px; flex-shrink: 0; }
#rtable .rrl .rrl-n { font-size: 10px; color: var(--c-dim); }
#rtable .rcl { text-align: center; width: 70px; min-width: 70px; padding: 4px; border-bottom: 1px solid rgba(255,255,255,.025); }
.rbtn { width: 40px; height: 28px; border-radius: 5px; border: none; font-size: 14px; transition: all .12s; }
.rdash { color: var(--c-faint); font-size: 12px; }
#rtip {
  margin-top: 16px; padding: 12px 14px; background: rgba(255,255,255,.03);
  border: 1px solid rgba(180,180,180,.12); border-radius: 8px; font-size: 10px; color: var(--c-dim); line-height: 1.8;
}

/* Shared form controls */
.fi {
  width: 100%; padding: 6px 9px; background: var(--c-input); border: 1px solid var(--c-border);
  border-radius: 5px; color: var(--c-text); font-size: 11px; outline: none; transition: border-color .15s;
}
.fi:focus { border-color: var(--c-border2); }
.fsel { appearance: none; cursor: pointer; }
.fl { font-size: 9px; color: var(--c-dim); display: block; margin-bottom: 4px; letter-spacing: .05em; }
.fbtn { padding: 6px 12px; border-radius: 5px; border: 1px solid; font-size: 10px; white-space: nowrap; transition: all .15s; }
.fp  { border-color: rgba(180,180,180,.35); color: #a0a0a0; background: rgba(180,180,180,.08); }
.fp:hover  { background: rgba(180,180,180,.18); }
.fd  { border-color: rgba(239,68,68,.25);  color: #ef4444; background: rgba(239,68,68,.07);  }
.fd:hover  { background: rgba(239,68,68,.15); }
.fm  { border-color: var(--c-border); color: var(--c-dim); background: rgba(255,255,255,.02); }
.fm:hover  { border-color: var(--c-border2); color: var(--c-text); }

/* Animations */
@keyframes pulse { 0%,100% { transform: translateY(-50%) scale(1); opacity:.5 } 50% { transform: translateY(-50%) scale(1.3); opacity:1 } }
@keyframes fadein {
  0%   { opacity:0; transform: translateX(-50%) translateY(10px); }
  15%  { opacity:1; transform: translateX(-50%) translateY(0); }
  80%  { opacity:1; }
  100% { opacity:0; }
}
</style>
</head>
<body>
<div id="app">

  <!--════════════ PALETTE ════════════-->
  <div id="palette">
    <div id="pal-logo">
      <div id="logo-icon"><img
    src="static/logo.svg"
    width="34"
    height="30"
    alt="logo"
  ></div>
      <div class="name">TOPOLOGY</div>
      <div class="sub">JSON BUILDER</div>
    </div>
    <div id="pal-nodes">
      <span class="section-label">ADD NODE</span>
      <div id="pal-btns"></div>
    </div>
    <div id="pal-footer">
      <button id="btn-settings">⚙  SETTINGS</button>
      <div id="pal-stats">
        <div><em id="sn">0</em> nodes</div>
        <div><em id="se">0</em> edges</div>
      </div>
    </div>
  </div>

  <!--════════════ CANVAS ════════════-->
  <div id="canvas">
    <div id="world">
      <svg id="esvg">
        <defs>
          <filter id="glo" x="-60%" y="-60%" width="220%" height="220%">
            <feGaussianBlur stdDeviation="3.5" result="b"/>
            <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>
      </svg>
    </div>
    <div id="c-toolbar">
      <button id="btn-del-node" class="c-tbtn">✕  DELETE NODE</button>
      <button id="btn-hide-panel" class="c-tbtn">HIDE JSON ›</button>
    </div>
    <div id="zoom-ui">
      <button class="zbtn" id="zi">+</button>
      <div id="zoom-pct">100%</div>
      <button class="zbtn" id="zo">−</button>
    </div>
    <div id="conn-hint">Drag to a <strong>pulsing port</strong> · <span>Dimmed</span> = rule blocked</div>
    <div id="flash"></div>
    <div id="empty">
      <div class="et">TOPOLOGY CANVAS</div>
      <div class="ei">
        <span style="opacity:.05">⬡</span><span style="opacity:.08">▣</span>
        <span style="opacity:.11">◈</span><span style="opacity:.08">◻</span><span style="opacity:.05">◬</span>
      </div>
      <div class="eh">← Add nodes from the palette</div>
      <div class="es">Scroll to zoom · Middle-mouse to pan · Drag ● to ○ to connect</div>
    </div>
  </div>

  <!--════════════ RIGHT PANEL ════════════-->
  <div id="right">
    <div id="props"><div id="props-inner"><p class="props-empty">SELECT A NODE TO EDIT</p></div></div>
    <div id="jpanel">
      <div id="jhead">
        <span>JSON · NESTED OUTPUT</span>
        <div id="jbtns">
          <button id="btn-copy" class="jbtn">Copy</button>
          <button id="btn-dl"   class="jbtn">↓ Save</button>
        </div>
      </div>
      <pre id="jout"><span style="color:var(--c-faint)">// Add nodes to see output</span></pre>
      <div id="jfoot">
        <div><em id="jb">0</em> bytes</div>
        <div><em id="jn">0</em> nodes</div>
        <div><em id="je">0</em> edges</div>
      </div>
    </div>
  </div>
</div>

<!--════════════ SETTINGS MODAL ════════════-->
<div id="overlay">
  <div id="modal">
    <div id="mhead">
      <div>
        <h2>SETTINGS</h2>
        <p>NODE TYPES · PROPERTY SCHEMAS · CONNECTION RULES</p>
      </div>
      <div id="mhead-btns">
        <button id="btn-m-export" class="m-btn">↓ Export Config</button>
        <button id="btn-m-import" class="m-btn">↑ Import Config</button>
        <input id="file-import" type="file" accept=".json" style="display:none">
        <button id="btn-m-close"  class="m-btn">✕</button>
      </div>
    </div>
    <div id="mtabs">
      <button class="mtab on" data-p="tp">NODE TYPES &amp; SCHEMAS</button>
      <button class="mtab"    data-p="rp">CONNECTION RULES</button>
    </div>
    <div id="mbody">
      <!-- Types panel -->
      <div id="tp" class="mpanel on">
        <div id="tlist">
          <label>NODE TYPES</label>
          <div id="tlist-items"></div>
          <div id="tadd">
            <input id="new-key" class="fi" placeholder="new-type-key" style="font-size:10px">
            <button id="btn-add-type" class="fbtn fp">+</button>
          </div>
        </div>
        <div id="tschema">
          <div id="tschema-ph">← Select a type to edit its schema</div>
          <div id="tschema-ed">
            <div id="tschema-title" style="font-size:9px;letter-spacing:.12em;margin-bottom:12px"></div>
            <div id="tmeta-row">
              <div><label class="fl">LABEL</label><input id="m-label" class="fi"></div>
              <div>
                <label class="fl">COLOR (HEX)</label>
                <div id="tmeta-color">
                  <input id="m-color"  class="fi" style="flex:1">
                  <input id="color-pick" type="color">
                </div>
              </div>
              <div><label class="fl">ICON</label><input id="m-icon" class="fi" style="text-align:center;font-size:16px" maxlength="2"></div>
              <div style="display:flex;align-items:flex-end">
                <button id="btn-save-meta" class="fbtn fp">✓ Save</button>
              </div>
            </div>
            <div id="tprops-hd">PROPERTY SCHEMA</div>
            <div id="tprops-list"></div>
            <button id="btn-add-prop">+ ADD PROPERTY</button>
          </div>
        </div>
      </div>
      <!-- Rules panel -->
      <div id="rp" class="mpanel">
        <p>Row = parent. Column = allowed child. Click a cell to toggle the rule.</p>
        <div id="rtable-wrap"><table id="rtable"></table></div>
        <div id="rtip">
          <strong style="color:#a0a0a0">Tip:</strong> Export Config → paste into
          <code style="color:#7cb87c">DEFAULT_CONFIG</code> in <code>app.py</code>
          to bake your settings in as permanent defaults.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';
//═══════════════════════════════════════════════════════════════════════════════
//  TOPOLOGY BUILDER — complete client application
//  Communicates with app.py exclusively through fetch('/api/...')
//═══════════════════════════════════════════════════════════════════════════════

// ── API ──────────────────────────────────────────────────────────────────────
const $ = s => document.querySelector(s);
const get  = url      => fetch(url).then(r => r.json());
const post = (url, d) => fetch(url, {method:'POST',   headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}).then(r=>r.json());
const put  = (url, d) => fetch(url, {method:'PUT',    headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}).then(r=>r.json());
const patch= (url, d) => fetch(url, {method:'PATCH',  headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)}).then(r=>r.json());
const del  = url      => fetch(url, {method:'DELETE'}).then(r=>r.json());

// ── Canvas constants ─────────────────────────────────────────────────────────
const NW = 252, HH = 44, RH = 24;

// ── Local state (mirror of server, updated by poll) ──────────────────────────
let cfg = {nodeTypes:{}, rules:{}};
let nodes = [], edges = [], selId = null, ver = -1;

// ── Viewport ─────────────────────────────────────────────────────────────────
let zoom = 1, px = 80, py = 40;

// ── Interaction ──────────────────────────────────────────────────────────────
let drag = null, didDrag = false;
let pan  = null, didPan = false;  // {mx,my,ox,oy}
let conn = null;   // {fromId}
let live = null;   // live SVG line while connecting

// ── DOM shortcuts ────────────────────────────────────────────────────────────
const cvs    = $('#canvas');
const world  = $('#world');
const esvg   = $('#esvg');
const flash  = $('#flash');
const empty  = $('#empty');
const jout   = $('#jout');
const propsEl= $('#props-inner');
const btnDel = $('#btn-del-node');

// ═════════════════════════════════════════════════════════════════════════════
//  GEOMETRY
// ═════════════════════════════════════════════════════════════════════════════
function nodeH(n) {
  const td = cfg.nodeTypes[n.type];
  let h = HH;
  for (const [k,v] of Object.entries(n.props||{})) {
    h += RH;
    const pd = td?.props?.[k];
    if (pd?.type==='multiselect' && Array.isArray(v) && v.length)
      h += Math.ceil(v.length/3)*19;
  }
  return h + 8;
}
const outP = n => ({x: n.x+NW,  y: n.y+nodeH(n)/2});
const inP  = n => ({x: n.x,     y: n.y+nodeH(n)/2});
const bz   = (ax,ay,bx,by) => {
  const dx = Math.max(Math.abs(bx-ax)*.5, 60);
  return `M${ax},${ay} C${ax+dx},${ay} ${bx-dx},${by} ${bx},${by}`;
};
function s2w(sx,sy) {
  const r = cvs.getBoundingClientRect();
  return {x:(sx-r.left-px)/zoom, y:(sy-r.top-py)/zoom};
}

// ═════════════════════════════════════════════════════════════════════════════
//  TRANSFORM
// ═════════════════════════════════════════════════════════════════════════════
function applyTx() {
  world.style.transform = `translate(${px}px,${py}px) scale(${zoom})`;
  const s1=`${100*zoom}px ${100*zoom}px`, s2=`${20*zoom}px ${20*zoom}px`;
  cvs.style.backgroundSize = `${s1},${s1},${s2},${s2}`;
  const bp = `${px}px ${py}px`;
  cvs.style.backgroundPosition = `${bp},${bp},${bp},${bp}`;
  $('#zoom-pct').textContent = Math.round(zoom*100)+'%';
}

// ═════════════════════════════════════════════════════════════════════════════
//  FLASH
// ═════════════════════════════════════════════════════════════════════════════
function showFlash(msg, col='#ef4444') {
  flash.textContent = msg;
  flash.style.color  = col;
  flash.style.borderColor = col+'55';
  flash.style.animation = 'none';
  flash.style.display = 'block';
  void flash.offsetWidth;
  flash.style.animation = 'fadein 2.6s ease forwards';
  setTimeout(()=>{ flash.style.display='none'; }, 2600);
}

// ═════════════════════════════════════════════════════════════════════════════
//  RENDER — NODES
// ═════════════════════════════════════════════════════════════════════════════
function renderNodes() {
  world.querySelectorAll('.node').forEach(el=>el.remove());

  const connNode  = conn ? nodes.find(n=>n.id===conn.fromId) : null;
  const validT    = connNode ? (cfg.rules[connNode.type]||[]) : [];

  for (const n of nodes) {
    const td  = cfg.nodeTypes[n.type] || {color:'#64748b',icon:'○',label:n.type,props:{}};
    const col = td.color;
    const h   = nodeH(n);
    const sel = n.id===selId;
    const src = conn && conn.fromId===n.id;
    const ok  = conn && !src && validT.includes(n.type);
    const bad = conn && !src && !validT.includes(n.type);

    const div = document.createElement('div');
    div.className = 'node';
    div.dataset.id = n.id;
    Object.assign(div.style, {
      left:  n.x+'px', top: n.y+'px',
      width: NW+'px',  height: h+'px',
      borderColor: sel ? col : ok ? col+'99' : bad ? 'rgba(239,68,68,.25)' : col+'32',
      boxShadow: sel
        ? `0 0 0 1px ${col}22, 0 10px 40px rgba(0,0,0,.7), 0 0 32px ${col}14`
        : ok  ? `0 0 20px ${col}28`
        : '0 4px 20px rgba(0,0,0,.5)',
      opacity: bad ? '0.35' : '1',
      zIndex:  sel ? '15' : '5',
      cursor:  'grab',
    });

    // head
    const head = document.createElement('div');
    head.className = 'node-head';
    head.style.background = `linear-gradient(135deg,${col}14,transparent)`;
    head.innerHTML = `
      <span class="node-icon" style="color:${col}">${td.icon}</span>
      <div class="node-title">
        <div class="node-name">${esc(n.label)}</div>
        <div class="node-type" style="color:${col}">${td.label}</div>
      </div>`;
    div.appendChild(head);

    // props
    const pd = document.createElement('div');
    pd.className = 'node-props';
    for (const [k,v] of Object.entries(n.props||{})) {
      const fd = td.props?.[k];
      const row = document.createElement('div');
      row.className = 'prow';
      if (fd?.type==='multiselect' && Array.isArray(v) && v.length) {
        row.style.cssText = 'flex-direction:column;align-items:flex-start;height:auto';
        row.innerHTML = `
          <div style="display:flex;gap:6px;align-items:center;height:${RH}px;width:100%">
            <span class="pk">${esc(fd?.label??k)}</span>
            <span class="pv" style="color:${col}">${v.length} selected</span>
          </div>
          <div class="ptags">${v.map(t=>`<span class="ptag" style="color:${col};background:${col}16;border-color:${col}35">${esc(t)}</span>`).join('')}</div>`;
      } else {
        row.innerHTML = `<span class="pk">${esc(fd?.label??k)}</span><span class="pv">${esc(Array.isArray(v)?'(none)':(v||'—'))}</span>`;
      }
      pd.appendChild(row);
    }
    div.appendChild(pd);

    // port-in
    const pi = document.createElement('div');
    pi.className = 'port port-in';
    pi.dataset.portType='in'; pi.dataset.nodeId=n.id;
    pi.style.borderColor = ok ? col : col+'55';
    if (ok) pi.style.animation = 'pulse 1.1s ease-in-out infinite';
    div.appendChild(pi);

    // port-out
    const po = document.createElement('div');
    po.className = 'port port-out';
    po.dataset.portType='out'; po.dataset.nodeId=n.id;
    po.style.cssText = `background:${col};border-color:${col};box-shadow:0 0 8px ${col}66`;
    div.appendChild(po);

    world.appendChild(div);
  }

  empty.style.display   = nodes.length ? 'none' : 'flex';
  btnDel.style.display  = selId ? 'block' : 'none';
}

// ═════════════════════════════════════════════════════════════════════════════
//  RENDER — EDGES
// ═════════════════════════════════════════════════════════════════════════════
const NS = 'http://www.w3.org/2000/svg';
const mkSvg = (t,a={}) => { const e=document.createElementNS(NS,t); for(const[k,v] of Object.entries(a)) e.setAttribute(k,v); return e; };

function renderEdges() {
  esvg.querySelectorAll('.eg').forEach(el=>el.remove());
  if (live) { live.remove(); live=null; }

  for (const ed of edges) {
    const fn = nodes.find(n=>n.id===ed.from);
    const tn = nodes.find(n=>n.id===ed.to);
    if (!fn||!tn) continue;
    const fp=outP(fn), tp=inP(tn);
    const col = cfg.nodeTypes[fn.type]?.color ?? '#a0a0a0';
    const sel = ed.from===selId || ed.to===selId;
    const d   = bz(fp.x,fp.y,tp.x,tp.y);
    const mx  = (fp.x+tp.x)/2, my = (fp.y+tp.y)/2;

    const g = mkSvg('g'); g.classList.add('eg'); g.dataset.eid = ed.id; g.style.pointerEvents='all';

    // hit area
    g.appendChild(mkSvg('path',{d,fill:'none',stroke:'transparent','stroke-width':'18'}));
    // glow
    if (sel) g.appendChild(mkSvg('path',{d,fill:'none',stroke:col,'stroke-width':'6',opacity:'.09',filter:'url(#glo)'}));
    // line
    g.appendChild(mkSvg('path',{d,fill:'none',stroke:sel?col:'rgba(200,200,200,.35)','stroke-width':sel?'1.8':'1.1'}));
    // endpoint dot
    g.appendChild(mkSvg('circle',{cx:tp.x,cy:tp.y,r:'3.5',fill:sel?col:'rgba(200,200,200,.5)'}));
    // delete button (shown on hover via CSS)
    const db = mkSvg('circle',{cx:mx,cy:my,r:'9',fill:'#0d0d0d',stroke:'rgba(239,68,68,.55)','stroke-width':'1.5',class:'edel'});
    const dt = mkSvg('text',  {x:mx,y:my+3.5,'text-anchor':'middle','font-size':'9',fill:'#ef4444',class:'edel',style:'font-weight:700;font-family:sans-serif'});
    dt.textContent='✕';
    g.appendChild(db); g.appendChild(dt);

    esvg.appendChild(g);
  }
}

function render() { renderNodes(); renderEdges(); }

// ═════════════════════════════════════════════════════════════════════════════
//  POLL
// ═════════════════════════════════════════════════════════════════════════════
async function poll() {
  const data = await get('/api/state').catch(()=>null);
  if (!data || data.v === ver) return;
  ver   = data.v;
  nodes = data.nodes;
  edges = data.edges;
  selId = data.sel;
  render();
  refreshJson();
  refreshProps();
}
setInterval(poll, 280);

// ═════════════════════════════════════════════════════════════════════════════
//  JSON PANEL
// ═════════════════════════════════════════════════════════════════════════════
function hl(s) {
  return s
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/("(?:[^"\\]|\\.)*")(\s*:)/g,'<span class="jk">$1</span>$2')
    .replace(/:\s*("(?:[^"\\]|\\.)*")/g,': <span class="js">$1</span>')
    .replace(/:\s*(-?\d+\.?\d*)/g,': <span class="jn">$1</span>')
    .replace(/:\s*(true|false)/g,': <span class="jb">$1</span>')
    .replace(/:\s*(null)/g,': <span class="jnu">$1</span>');
}

async function refreshJson() {
  const data = await get('/api/json').catch(()=>null);
  if (!data) return;
  const txt = JSON.stringify(data,null,2);
  jout.innerHTML = nodes.length
    ? hl(txt)
    : '<span style="color:var(--c-faint)">// Add nodes to see output</span>';
  const bytes = new Blob([txt]).size;
  $('#jb').textContent = bytes;
  $('#jn').textContent = nodes.length;
  $('#je').textContent = edges.length;
  $('#sn').textContent = nodes.length;
  $('#se').textContent = edges.length;
}

$('#btn-copy').onclick = async () => {
  const data = await get('/api/json');
  await navigator.clipboard.writeText(JSON.stringify(data,null,2));
  const b=$('#btn-copy'); b.textContent='✓ Copied'; b.classList.add('ok');
  setTimeout(()=>{b.textContent='Copy';b.classList.remove('ok');},2000);
};
$('#btn-dl').onclick = async () => {
  const data = await get('/api/json');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));
  a.download='topology.json'; a.click();
};

// ═════════════════════════════════════════════════════════════════════════════
//  PROPERTY EDITOR
// ═════════════════════════════════════════════════════════════════════════════
function refreshProps() {
  const n = nodes.find(n=>n.id===selId);
  if (!n) { propsEl.innerHTML='<p class="props-empty">SELECT A NODE TO EDIT</p>'; return; }
  const td=cfg.nodeTypes[n.type]||{color:'#64748b',icon:'○',label:n.type,props:{}};
  const col=td.color;

  let h = `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
      <span style="font-size:18px;color:${col}">${td.icon}</span>
      <div>
        <div style="font-size:9px;color:${col};font-weight:700;letter-spacing:.12em">${esc(td.label.toUpperCase())}</div>
        <div style="font-size:8px;color:var(--c-faint)">PROPERTIES</div>
      </div>
    </div>
    <label class="pf-label">LABEL</label>
    <input class="pf-input" style="border-color:${col}55" value="${esc(n.label)}"
      onchange="patchLabel('${n.id}',this.value)">`;

  for (const [k,v] of Object.entries(n.props||{})) {
    const pd=td.props?.[k], pt=pd?.type??'text', pl=pd?.label??k;
    h += `<label class="pf-label">${esc(pl.toUpperCase())}</label>`;

    if (pt==='select') {
      h += `<select class="pf-input pf-select" onchange="patchProp('${n.id}','${k}',this.value)">`;
      for (const o of pd.options||[])
        h += `<option value="${esc(o)}" ${o===v?'selected':''}>${esc(o)}</option>`;
      h += `</select>`;

    } else if (pt==='multiselect') {
      const sel = Array.isArray(v)?v:[];
      h += `<div class="ms-wrap">`;
      for (const o of pd.options||[]) {
        const on=sel.includes(o);
        h += `<div class="ms-opt" data-nid="${n.id}" data-key="${k}" data-opt="${esc(o)}"
          style="background:${on?col+'1a':'rgba(255,255,255,.03)'};color:${on?col:'var(--c-faint)'};border-color:${on?col+'55':'rgba(255,255,255,.08)'}">
          ${on?'✓ ':''}${esc(o)}</div>`;
      }
      h += `</div>`;

    } else if (pt==='number') {
      h += `<input type="number" class="pf-input" value="${esc(String(v??''))}"
        onchange="patchProp('${n.id}','${k}',this.value)">`;
    } else {
      h += `<input class="pf-input" value="${esc(String(v??''))}"
        onchange="patchProp('${n.id}','${k}',this.value)">`;
    }
  }
  propsEl.innerHTML = h;

  // multiselect click handlers
  propsEl.querySelectorAll('.ms-opt').forEach(el=>{
    el.addEventListener('click',()=>{
      const n2=nodes.find(n=>n.id===el.dataset.nid);
      if(!n2) return;
      const cur=Array.isArray(n2.props[el.dataset.key])?[...n2.props[el.dataset.key]]:[];
      const nv =cur.includes(el.dataset.opt)?cur.filter(x=>x!==el.dataset.opt):[...cur,el.dataset.opt];
      patchProp(el.dataset.nid, el.dataset.key, nv);
    });
  });
}

async function patchLabel(id, v) { await patch(`/api/node/${id}`,{label:v}); }
async function patchProp(id, k, v) {
  const n=nodes.find(n=>n.id===id);
  if(n) n.props[k]=v;   // optimistic local update
  refreshProps();
  await patch(`/api/node/${id}`,{props:{[k]:v}});
}

// ═════════════════════════════════════════════════════════════════════════════
//  CANVAS EVENTS
// ═════════════════════════════════════════════════════════════════════════════
cvs.addEventListener('mousedown', async e => {
  // ── Guard: never intercept clicks on overlay UI or SVG edge elements ────────
  // If we let mousedown run its deselect/render logic on these, it destroys the
  // DOM elements before their own click handlers fire.
  const isUI   = e.target.closest('button, input, select, #c-toolbar, #zoom-ui');
  const isEdge = e.target.closest('.eg');   // edge group — handled by its own listener
  if (isUI || isEdge) return;

  const port   = e.target.closest('[data-port-type="out"]');
  const portIn = e.target.closest('[data-port-type="in"]');
  const nodeEl = e.target.closest('.node');

  // ── Middle mouse OR left-click on empty background → pan ────────────────────
  // Left-click pan lets laptop users drag the canvas without a scroll wheel.
  // We defer the deselect decision to mouseup so a plain click still deselects.
  if (e.button === 1 || (e.button === 0 && !nodeEl && !port && !portIn)) {
    e.preventDefault();
    pan = { mx: e.clientX, my: e.clientY, ox: px, oy: py };
    didPan = false;
    cvs.style.cursor = 'grabbing';
    return;
  }
  if (e.button !== 0) return;

  // ── Output port → start connection ──────────────────────────────────────────
  if (port) {
    e.preventDefault(); e.stopPropagation();
    conn = { fromId: port.dataset.nodeId };
    $('#conn-hint').style.display = 'block';
    render();
    return;
  }

  // ── Node body → select + begin drag ─────────────────────────────────────────
  if (nodeEl) {
    e.stopPropagation();
    const id = nodeEl.dataset.id;
    const n  = nodes.find(n => n.id === id);
    if (!n) return;
    didDrag = false; selId = id;
    await put(`/api/node/${id}/select`);
    const w = s2w(e.clientX, e.clientY);
    drag = { id, ox: w.x - n.x, oy: w.y - n.y };
    render();
    return;
  }
});

cvs.addEventListener('mousemove', e => {
  if (pan) {
    px = pan.ox + (e.clientX - pan.mx);
    py = pan.oy + (e.clientY - pan.my);
    // Only count as a pan if the cursor actually moved (avoids swallowing plain clicks)
    if (Math.abs(e.clientX - pan.mx) > 3 || Math.abs(e.clientY - pan.my) > 3) didPan = true;
    applyTx();
    return;
  }

  if (conn) {
    const cn = nodes.find(n => n.id === conn.fromId);
    if (cn) {
      const fp = outP(cn), w = s2w(e.clientX, e.clientY);
      const col = cfg.nodeTypes[cn.type]?.color ?? '#a0a0a0';
      if (live) live.remove();
      const g = document.createElementNS(NS, 'g');
      g.appendChild(mkSvg('path', {d:bz(fp.x,fp.y,w.x,w.y), fill:'none', stroke:col, 'stroke-width':'1.5', 'stroke-dasharray':'6 3', opacity:'.55'}));
      g.appendChild(mkSvg('circle', {cx:w.x, cy:w.y, r:'4.5', fill:col, opacity:'.35'}));
      esvg.appendChild(g); live = g;
    }
    return;
  }

  if (drag) {
    didDrag = true;
    const w = s2w(e.clientX, e.clientY);
    const n = nodes.find(n => n.id === drag.id);
    if (n) { n.x = w.x - drag.ox; n.y = w.y - drag.oy; renderNodes(); renderEdges(); }
  }
});

cvs.addEventListener('mouseup', async e => {
  if (pan) {
    cvs.style.cursor = '';
    if (!didPan) {
      // Plain click on background (no movement) → deselect
      selId = null;
      await del('/api/node/deselect');
      render();
    }
    pan = null;
    return;
  }

  if (conn) {
    if (live) { live.remove(); live = null; }
    $('#conn-hint').style.display = 'none';
    const dst = e.target.closest('[data-port-type="in"]');
    if (dst) {
      const r = await post('/api/edge', {from: conn.fromId, to: dst.dataset.nodeId});
      if (!r.ok) showFlash('✕  ' + r.error);
      else { edges.push(r.edge); renderEdges(); refreshJson(); }
    }
    conn = null; render(); return;
  }

  if (drag) {
    const n = nodes.find(n => n.id === drag.id);
    if (n && didDrag) await put(`/api/node/${n.id}/pos`, {x: n.x, y: n.y});
    drag = null;
  }
});

// ── Edge delete ──────────────────────────────────────────────────────────────
// Listening on `document` rather than `esvg` so the event is guaranteed to
// reach us even if the SVG has pointer-events:none on the container element.
document.addEventListener('click', async e => {
  // Only handle clicks that originated inside the SVG edge groups
  const g = e.target.closest('.eg');
  if (!g) return;
  e.stopPropagation();
  const eid = g.dataset.eid;
  if (!eid) return;
  await del(`/api/edge/${eid}`);
  edges = edges.filter(ed => ed.id !== eid);
  renderEdges(); refreshJson();
});

// keyboard delete
window.addEventListener('keydown', async e => {
  if ((e.key==='Delete'||e.key==='Backspace') && !['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) {
    if(!selId) return;
    await del(`/api/node/${selId}`);
    selId=null;
    await poll();
  }
});

// toolbar delete button
btnDel.onclick = async () => {
  if(!selId) return;
  await del(`/api/node/${selId}`);
  selId=null; await poll();
};

// toggle right panel
let panelVisible=true;
$('#btn-hide-panel').onclick=()=>{
  panelVisible=!panelVisible;
  $('#right').style.display=panelVisible?'flex':'none';
  $('#btn-hide-panel').textContent=panelVisible?'HIDE JSON ›':'‹ SHOW JSON';
};

// zoom wheel
cvs.addEventListener('wheel', e=>{
  e.preventDefault();
  const r=cvs.getBoundingClientRect();
  const cx=e.clientX-r.left, cy=e.clientY-r.top;
  const nz=Math.min(3,Math.max(.15, zoom*(e.deltaY<0?1.12:.89)));
  px=cx-(cx-px)*(nz/zoom); py=cy-(cy-py)*(nz/zoom);
  zoom=nz; applyTx();
},{passive:false});

$('#zi').onclick=()=>{zoom=Math.min(3,zoom*1.2); applyTx();};
$('#zo').onclick=()=>{zoom=Math.max(.15,zoom/1.2);applyTx();};
$('#zoom-pct').onclick=()=>{zoom=1;px=80;py=40;applyTx();};

// ═════════════════════════════════════════════════════════════════════════════
//  PALETTE
// ═════════════════════════════════════════════════════════════════════════════
function buildPalette() {
  const c=$('#pal-btns'); c.innerHTML='';
  for (const [k,td] of Object.entries(cfg.nodeTypes)) {
    const b=document.createElement('button');
    b.className='pal-btn';
    b.style.color=td.color; b.style.borderColor=td.color+'38'; b.style.backgroundColor=td.color+'0b';
    b.innerHTML=`<span class="pi">${td.icon}</span>${td.label}`;
    b.onclick=async()=>{
      const n=await post('/api/node',{type:k});
      nodes.push(n); ver=-1; // force refresh
      await poll();
    };
    c.appendChild(b);
  }
}

// ═════════════════════════════════════════════════════════════════════════════
//  SETTINGS
// ═════════════════════════════════════════════════════════════════════════════
let editKey=null;

const overlay=$('#overlay');
$('#btn-settings').onclick=()=>{buildTypeList();overlay.classList.add('open');};
$('#btn-m-close').onclick =()=>overlay.classList.remove('open');
overlay.addEventListener('click',e=>{if(e.target===overlay)overlay.classList.remove('open');});

// tabs
document.querySelectorAll('.mtab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.mtab').forEach(x=>x.classList.remove('on'));
    document.querySelectorAll('.mpanel').forEach(x=>x.classList.remove('on'));
    t.classList.add('on');
    document.getElementById(t.dataset.p).classList.add('on');
    if(t.dataset.p==='rp') buildRulesTable();
  });
});

// export / import
$('#btn-m-export').onclick=async()=>{
  const d=await get('/api/settings');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json'}));
  a.download='topology-settings.json'; a.click();
};
$('#btn-m-import').onclick=()=>$('#file-import').click();
$('#file-import').onchange=async e=>{
  const f=e.target.files[0]; if(!f) return;
  try {
    const d=JSON.parse(await f.text());
    await post('/api/settings',d);
    cfg=await get('/api/config');
    buildPalette(); buildTypeList();
    if(editKey) buildSchema(editKey);
    alert('Config imported.');
  } catch(ex){alert('Import failed: '+ex.message);}
  e.target.value='';
};

// ── Type list ─────────────────────────────────────────────────────────────────
function buildTypeList() {
  const c=$('#tlist-items'); c.innerHTML='';
  for (const [k,td] of Object.entries(cfg.nodeTypes)) {
    const div=document.createElement('div');
    div.className='ti'+(editKey===k?' on':'');
    div.style.borderColor=editKey===k?td.color+'55':'rgba(255,255,255,.04)';
    div.innerHTML=`
      <span class="tiicon" style="color:${td.color}">${td.icon}</span>
      <div class="tiinfo">
        <div class="tiname">${esc(td.label)}</div>
        <div class="timeta">${k} · ${Object.keys(td.props||{}).length} props</div>
      </div>
      <span class="tidel" data-k="${k}">✕</span>`;
    div.querySelector('.tidel').onclick=async ev=>{
      ev.stopPropagation();
      if(!confirm(`Delete type "${td.label}"?`)) return;
      await del(`/api/settings/type/${k}`);
      cfg=await get('/api/config');
      if(editKey===k){editKey=null;schemaEmpty();}
      buildPalette(); buildTypeList();
    };
    div.onclick=()=>{editKey=k; buildTypeList(); buildSchema(k);};
    c.appendChild(div);
  }
}

$('#btn-add-type').onclick=async()=>{
  const inp=$('#new-key');
  const k=inp.value.trim().toLowerCase().replace(/\s+/g,'_');
  if(!k){return;}
  if(cfg.nodeTypes[k]){alert('Type key already exists.');return;}
  const td={label:k.charAt(0).toUpperCase()+k.slice(1), color:'#94a3b8', icon:'○', props:{}};
  await put(`/api/settings/type/${k}`,td);
  cfg=await get('/api/config');
  inp.value=''; editKey=k;
  buildPalette(); buildTypeList(); buildSchema(k);
};

// ── Schema editor ─────────────────────────────────────────────────────────────
function schemaEmpty() {
  $('#tschema-ph').style.display='flex';
  $('#tschema-ed').style.display='none';
}
function buildSchema(key) {
  const td=cfg.nodeTypes[key]; if(!td) return;
  const col=td.color;
  $('#tschema-ph').style.display='none';
  $('#tschema-ed').style.display='block';
  $('#tschema-title').textContent=`EDITING · ${key.toUpperCase()}`;
  $('#tschema-title').style.color=col;
  $('#m-label').value=td.label;
  $('#m-color').value=td.color;
  $('#color-pick').value=td.color;
  $('#m-icon').value=td.icon;

  $('#m-color').oninput =e=>$('#color-pick').value=e.target.value;
  $('#color-pick').oninput=e=>$('#m-color').value=e.target.value;

  $('#btn-save-meta').onclick=async()=>{
    const upd={...cfg.nodeTypes[key], label:$('#m-label').value, color:$('#m-color').value, icon:$('#m-icon').value};
    await put(`/api/settings/type/${key}`,upd);
    cfg=await get('/api/config');
    buildPalette(); buildTypeList(); buildSchema(key);
  };

  buildPropList(key);

  $('#btn-add-prop').onclick=async()=>{
    const pk='prop_'+Math.random().toString(36).slice(2,6);
    cfg.nodeTypes[key].props=cfg.nodeTypes[key].props||{};
    cfg.nodeTypes[key].props[pk]={type:'text',label:pk,default:''};
    await put(`/api/settings/type/${key}`,cfg.nodeTypes[key]);
    cfg=await get('/api/config');
    buildPropList(key);
  };
}

function buildPropList(key) {
  const td=cfg.nodeTypes[key];
  const list=$('#tprops-list'); list.innerHTML='';

  for (const [pk,pd] of Object.entries(td.props||{})) {
    const showOpts=['select','multiselect'].includes(pd.type);
    const card=document.createElement('div'); card.className='prop-card';

    card.innerHTML=`
      <div class="prop-row1">
        <div><label class="fl">KEY</label><input class="fi" id="pk-${pk}" value="${esc(pk)}" style="font-size:10px"></div>
        <div><label class="fl">LABEL</label><input class="fi" id="pl-${pk}" value="${esc(pd.label??pk)}" style="font-size:10px"></div>
        <div><label class="fl">TYPE</label>
          <select class="fi fsel" id="pt-${pk}" style="font-size:10px">
            ${['text','number','select','multiselect'].map(t=>`<option ${t===pd.type?'selected':''}>${t}</option>`).join('')}
          </select></div>
        <div><label class="fl">DEFAULT</label>
          <input class="fi" id="pd-${pk}" value="${esc(String(pd.default??''))}" style="font-size:10px"
            ${pd.type==='multiselect'?'disabled placeholder="[] auto"':''}></div>
        <div style="display:flex;flex-direction:column;justify-content:flex-end;gap:4px">
          <button class="fbtn fp" id="ps-${pk}" style="font-size:9px">Save</button>
          <button class="fbtn fd" id="pp-${pk}" style="font-size:9px">Del</button>
        </div>
      </div>
      ${showOpts?`
      <div class="prop-opts">
        <label>OPTIONS</label>
        <div class="optags" id="ot-${pk}"></div>
        <div class="oadd">
          <input class="fi" id="on-${pk}" placeholder="Add option…" style="font-size:10px">
          <button class="fbtn fm" id="oa-${pk}">+</button>
        </div>
      </div>`:''}`;
    list.appendChild(card);

    // options
    if (showOpts) {
      const renderOpts=()=>{
        const wrap=document.getElementById(`ot-${pk}`); wrap.innerHTML='';
        for(const [i,opt] of (td.props[pk]?.options||[]).entries()){
          const tag=document.createElement('div'); tag.className='otag';
          tag.innerHTML=`<span>${esc(opt)}</span><span class="ox" data-i="${i}">×</span>`;
          tag.querySelector('.ox').onclick=async()=>{
            td.props[pk].options.splice(i,1);
            await put(`/api/settings/type/${key}`,td);
            cfg=await get('/api/config');
            buildPropList(key);
          };
          wrap.appendChild(tag);
        }
      };
      renderOpts();
      document.getElementById(`oa-${pk}`).onclick=async()=>{
        const inp=document.getElementById(`on-${pk}`);
        const v=inp.value.trim(); if(!v) return;
        td.props[pk].options=td.props[pk].options||[];
        td.props[pk].options.push(v); inp.value='';
        await put(`/api/settings/type/${key}`,td);
        cfg=await get('/api/config'); buildPropList(key);
      };
    }

    // save prop
    document.getElementById(`ps-${pk}`).onclick=async()=>{
      const nk=document.getElementById(`pk-${pk}`).value.trim();
      const nt=document.getElementById(`pt-${pk}`).value;
      const nd=nt==='multiselect'?[]:document.getElementById(`pd-${pk}`).value;
      const nl=document.getElementById(`pl-${pk}`).value;
      if(!nk) return;
      const existing={...td.props[pk], label:nl, type:nt, default:nd};
      if(nk!==pk) delete td.props[pk];
      td.props[nk]=existing;
      await put(`/api/settings/type/${key}`,td);
      cfg=await get('/api/config'); buildPropList(key);
    };

    // delete prop
    document.getElementById(`pp-${pk}`).onclick=async()=>{
      delete td.props[pk];
      await put(`/api/settings/type/${key}`,td);
      cfg=await get('/api/config'); buildPropList(key);
    };
  }
}

// ── Rules matrix ──────────────────────────────────────────────────────────────
function buildRulesTable() {
  const tbl=$('#rtable');
  const keys=Object.keys(cfg.nodeTypes);

  let h=`<thead><tr><th class="rco">PARENT ↓ / CHILD →</th>`;
  for(const ck of keys){
    const td=cfg.nodeTypes[ck];
    h+=`<th class="rch"><span class="rch-i" style="color:${td.color}">${td.icon}</span><span class="rch-l">${esc(td.label)}</span></th>`;
  }
  h+=`</tr></thead><tbody>`;

  for(const pk of keys){
    const pd=cfg.nodeTypes[pk];
    h+=`<tr><td><div class="rrl"><span class="rrl-i" style="color:${pd.color}">${pd.icon}</span><span class="rrl-n">${esc(pd.label)}</span></div></td>`;
    for(const ck of keys){
      if(pk===ck){h+=`<td class="rcl"><span class="rdash">—</span></td>`;continue;}
      const on=(cfg.rules[pk]||[]).includes(ck);
      const cc=cfg.nodeTypes[ck];
      const [r,g,b]=[1,3,5].map(i=>parseInt(cc.color.slice(i,i+2),16));
      const bg=on?`rgba(${r},${g},${b},.15)`:'rgba(255,255,255,.02)';
      h+=`<td class="rcl"><button class="rbtn" data-pk="${pk}" data-ck="${ck}"
        style="background:${bg};color:${on?cc.color:'#2e2e2e'}">${on?'✓':'·'}</button></td>`;
    }
    h+=`</tr>`;
  }
  h+=`</tbody>`;
  tbl.innerHTML=h;

  tbl.querySelectorAll('.rbtn').forEach(btn=>{
    btn.addEventListener('click',async()=>{
      const {pk,ck}=btn.dataset;
      const cur=[...(cfg.rules[pk]||[])];
      const on=cur.includes(ck);
      const rules={...cfg.rules,[pk]:on?cur.filter(x=>x!==ck):[...cur,ck]};
      await put('/api/settings/rules',rules);
      cfg=await get('/api/config');
      buildRulesTable();
    });
  });
}

// ═════════════════════════════════════════════════════════════════════════════
//  UTILS
// ═════════════════════════════════════════════════════════════════════════════
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// ═════════════════════════════════════════════════════════════════════════════
//  BOOT
// ═════════════════════════════════════════════════════════════════════════════
(async()=>{
  cfg=await get('/api/config');
  buildPalette();
  applyTx();
  await poll();
})();
</script>
</body>
</html>